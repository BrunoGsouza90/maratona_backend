# =========================
# Arquivo principal nginx.conf.
# =========================

# -------------------------
# Bloco Main.
# -------------------------
worker_processes auto; # Número de processos de trabalho (auto = número de núcleos CPU).
error_log /var/log/nginx/error.log warn; # Log de erros.
pid /var/run/nginx.pid; # Arquivo com PID do master process.

# -------------------------
# Bloco Events.
# -------------------------
events {

    worker_connections 10240; # Número máximo de conexões simultâneas por worker.

}

# -------------------------
# Bloco HTTP
# -------------------------
http {

    include       mime.types; # Tipos MIME.
    default_type  application/octet-stream; # Tipo de arquivo não informado.
    sendfile        on; # Habilita envio de arquivos de forma eficiente.
    keepalive_timeout 65; # Tempo de conexões persistentes.
    gzip on; # Ativa compressão gzip.
    server_tokens off; # Oculta versão do Nginx por segurança.

    # -------------------------
    # Logs personalizados
    # -------------------------
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

    access_log /var/log/nginx/access.log main;

    # =========================
    # Servidores Virtuais (Virtual Hosts)
    # =========================

    # -------------------------
    # Site 1 - HTTP → HTTPS
    # -------------------------
    server {

        listen 80;
        server_name site1.com www.site1.com;

        # Redirecionamento permanente para HTTPS
        return 301 https://$host$request_uri;

    }

    # -------------------------
    # Site 1 - HTTPS
    # -------------------------
    server {

        listen 443 ssl;
        server_name site1.com www.site1.com;

        ssl_certificate /etc/ssl/certs/site1.crt;
        ssl_certificate_key /etc/ssl/private/site1.key;

        root /var/www/site1;
        index index.html index.htm;

        location / {

            try_files $uri $uri/ =404;

        }

        location /api/ {

            proxy_pass http://backend_site1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        }
    }

    # -------------------------
    # Site 2 - HTTP simples
    # -------------------------
    server {

        listen 80;
        server_name site2.com www.site2.com;

        root /var/www/site2;
        index index.html index.htm;

        location / {

            try_files $uri $uri/ =404;

        }

        # Alias para imagens
        location /imagens/ {

            alias /var/www/shared_images/;

        }

    }

    # =========================
    # Proxy reverso e Load Balancing
    # =========================

    # Definição dos servidores backend
    upstream backend_site1 {

        least_conn;  # Balanceamento pelo menor número de conexões
        server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:3001 max_fails=3 fail_timeout=30s;

    }

    # Cache de proxy
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=meucache:10m max_size=1g inactive=60m use_temp_path=off;

}